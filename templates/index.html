<!DOCTYPE html>
<html>
<head>
    <title>Rastreador de Seguridad Pro</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #1a1a1a; color: white; }
        #map { height: 60vh; width: 100%; border-bottom: 2px solid #333; }
        .ui-container { padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .status-bar { display: flex; justify-content: space-between; background: #333; padding: 10px 20px; border-radius: 10px; }
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        button { padding: 20px; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        button:active { transform: scale(0.95); }
        .btn-alert { background: #f39c12; color: white; }
        .btn-panic { background: #e74c3c; color: white; box-shadow: 0 0 15px rgba(231, 76, 60, 0.4); }
        .panic-active { animation: emergency-bg 0.5s infinite; }
        @keyframes emergency-bg { 0% { background: #1a1a1a; } 50% { background: #c0392b; } 100% { background: #1a1a1a; } }
    </style>
</head>
<body id="main-body">
    <div id="map"></div>
    
    <div class="ui-container">
        <div class="status-bar">
            <span>üîã Bater√≠a: <b id="bat-val">--</b></span>
            <span id="alert-status">‚úÖ Estado Normal</span>
        </div>

        <div class="btn-group">
            <button class="btn-alert" onclick="triggerEvent('alert')">‚ö†Ô∏è ALERTA</button>
            <button class="btn-panic" onclick="triggerEvent('panic')">üö® P√ÅNICO</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        var map = L.map('map').setView([0, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        
        var marker = L.marker([0, 0]).addTo(map);
        // Estela del viaje (L√≠nea roja)
        var path = L.polyline([], {color: '#e74c3c', weight: 4, opacity: 0.7}).addTo(map);

        let batteryInfo = "--";
        if (navigator.getBattery) {
            navigator.getBattery().then(bat => {
                batteryInfo = Math.round(bat.level * 100) + "%";
            });
        }

        async function triggerEvent(type) {
            const payload = type === 'alert' ? {alert: true} : {panic: true};
            await fetch('/update', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            alert("Sinal de " + type.toUpperCase() + " enviado!");
        }

        function startGPS() {
            navigator.geolocation.watchPosition(pos => {
                fetch('/update', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        lat: pos.coords.latitude, 
                        lng: pos.coords.longitude,
                        battery: batteryInfo
                    })
                });
            }, null, { enableHighAccuracy: true });
        }

        // Actualizaci√≥n visual cada 3 segundos
        setInterval(async () => {
            const res = await fetch('/location');
            const data = await res.json();
            
            if(data.lat !== 0) {
                const pos = [data.lat, data.lng];
                marker.setLatLng(pos);
                path.addLatLng(pos); // Dibuja la estela
                map.panTo(pos);
                
                document.getElementById('bat-val').innerText = data.battery;
                
                if(data.panic) {
                    document.getElementById('main-body').classList.add('panic-active');
                    document.getElementById('alert-status').innerText = "üö® EMERGENCIA ACTIVA";
                } else if(data.alert) {
                    document.getElementById('alert-status').innerText = "‚ö†Ô∏è PRECAUCI√ìN";
                }
            }
        }, 3000);

        startGPS();
    </script>
</body>
</html>
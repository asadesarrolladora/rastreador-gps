<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Monitor de Flota ASA</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #121212; color: white; }
        #map { height: 50vh; width: 100%; border-bottom: 2px solid #333; }
        .container { padding: 15px; max-width: 1100px; margin: auto; }
        
        /* Encabezado y Bot贸n de Descarga */
        .header-flex { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .btn-download { background: #27ae60; color: white; border: none; padding: 10px 18px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-download:hover { background: #2ecc71; }

        /* Estilos de Tabla */
        table { width: 100%; border-collapse: collapse; background: #1e1e1e; border-radius: 8px; overflow: hidden; }
        th { background: #2c3e50; padding: 12px; text-align: left; font-size: 12px; color: #bdc3c7; }
        td { padding: 12px; border-bottom: 1px solid #333; font-size: 14px; }

        /* Bot贸n de P谩nico Chofer */
        .btn-panic { width: 100%; padding: 25px; font-size: 1.3em; border-radius: 15px; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-off { background: #e74c3c; color: white; box-shadow: 0 4px #c0392b; }
        .btn-on { background: #2c3e50; color: #e74c3c; border: 4px solid #e74c3c; animation: blinker 1.5s linear infinite; }
        @keyframes blinker { 50% { opacity: 0.5; } }

        .status-pill { padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 11px; }
        .st-ok { background: #27ae60; }
        .st-panic { background: #e74c3c; }
    </style>
</head>
<body>

<div id="map"></div>

<div class="container">
    <div id="area-chofer" style="display:none; text-align: center; padding: 20px;">
        <button id="panic-btn" class="btn-panic btn-off" onclick="togglePanic()"> ACTIVAR PNICO</button>
        <p style="color: #888; margin-top: 15px;">Manten esta ventana activa para reportar tu ubicaci贸n.</p>
    </div>

    <div id="area-monitor">
        <div class="header-flex">
            <h3 style="margin:0;"> Panel de Control ASA</h3>
            <button class="btn-download" onclick="location.href='/descargar_reporte'"> Descargar Excel</button>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Unidad</th>
                    <th>Estado</th>
                    <th> Bater铆a</th>
                    <th> ltima Conexi贸n</th>
                </tr>
            </thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const urlParams = new URLSearchParams(window.location.search);
    const trailerId = urlParams.get('id');
    const isChofer = !!trailerId;

    var map = L.map('map').setView([19.43, -99.13], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    if (isChofer) {
        document.getElementById('area-chofer').style.display = 'block';
        document.getElementById('area-monitor').style.display = 'none';
    }

    var markers = {};
    var paths = {};
    var panicActive = false;
    let wakeLock = null;

    // Wake Lock (Evitar que se apague la pantalla)
    async function lockScreen() {
        try { if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); } catch (e) {}
    }

    function togglePanic() {
        panicActive = !panicActive;
        const btn = document.getElementById('panic-btn');
        btn.innerHTML = panicActive ? "锔 PNICO ACTIVO (Presiona para quitar)" : " ACTIVAR PNICO";
        btn.className = panicActive ? "btn-panic btn-on" : "btn-panic btn-off";
    }

    function enviarGPS(pos) {
        fetch('/update/' + trailerId, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                lat: pos.coords.latitude,
                lng: pos.coords.longitude,
                panic: panicActive,
                battery: "OK"
            })
        });
    }

    if (isChofer) {
        lockScreen();
        navigator.geolocation.watchPosition(pos => {
            map.setView([pos.coords.latitude, pos.coords.longitude], 16);
            enviarGPS(pos);
        }, null, { enableHighAccuracy: true });
    }

    async function refrescarMonitor() {
        const res = await fetch('/fleet');
        const fleet = await res.json();
        const tbody = document.getElementById('table-body');
        tbody.innerHTML = "";

        for (let id in fleet) {
            const data = fleet[id];
            const pos = [data.lat, data.lng];

            if (!markers[id]) {
                markers[id] = L.marker(pos).addTo(map).bindPopup(id);
                paths[id] = L.polyline([], {color: '#3498db', weight: 4}).addTo(map);
            }
            markers[id].setLatLng(pos);
            paths[id].setLatLngs(data.path);

            tbody.innerHTML += `
                <tr>
                    <td><b>${id}</b></td>
                    <td><span class="status-pill ${data.panic ? 'st-panic' : 'st-ok'}">${data.panic ? 'PNICO' : 'ONLINE'}</span></td>
                    <td>${data.battery}</td>
                    <td style="color:#3498db; font-weight:bold;">${data.last_seen}</td>
                </tr>`;
            
            if(data.panic) markers[id].openPopup();
        }
    }

    setInterval(refrescarMonitor, 4000);
</script>
</body>
</html>
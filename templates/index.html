<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Sistema de Flota ASA</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #121212; color: #e0e0e0; }
        #map { height: 50vh; width: 100%; border-bottom: 3px solid #333; }
        .container { padding: 15px; max-width: 1000px; margin: auto; }
        
        /* Tabla y Header */
        .header-flex { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; background: #1e1e1e; border-radius: 10px; overflow: hidden; }
        th { background: #2c3e50; padding: 12px; text-align: left; color: #bdc3c7; font-size: 12px; }
        td { padding: 12px; border-bottom: 1px solid #333; }

        /* Botones */
        .btn-panic { width: 100%; padding: 25px; font-size: 1.3em; border-radius: 15px; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; margin-top: 10px; }
        .btn-off { background: #e74c3c; color: white; box-shadow: 0 5px #c0392b; }
        .btn-on { background: #2c3e50; color: #e74c3c; border: 4px solid #e74c3c; animation: pulse 1.5s infinite; }
        .btn-download { background: #2980b9; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; }

        .status-pill { padding: 5px 10px; border-radius: 5px; font-weight: bold; font-size: 11px; }
        .st-ok { background: #27ae60; color: white; }
        .st-panic { background: #e74c3c; color: white; }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(231, 76, 60, 0); } 100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); } }
    </style>
</head>
<body>

<div id="map"></div>

<div class="container">
    <div id="area-chofer" style="display:none; text-align: center;">
        <button id="panic-btn" class="btn-panic btn-off" onclick="togglePanic()">游뚿 ACTIVAR P츼NICO</button>
        <p style="margin-top: 15px; color: #aaa;">Ubicaci칩n en vivo activa. No cierres esta pesta침a.</p>
    </div>

    <div id="area-monitor">
        <div class="header-flex">
            <h3>游늵 Monitor de Unidades</h3>
            <button class="btn-download" onclick="location.href='/descargar_reporte'">游닌 Descargar Excel</button>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Unidad</th>
                    <th>Estado</th>
                    <th>游 칔ltima Se침al</th>
                </tr>
            </thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const urlParams = new URLSearchParams(window.location.search);
    const trailerId = urlParams.get('id');
    const isChofer = !!trailerId;

    var map = L.map('map').setView([19.43, -99.13], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    var markers = {};
    var paths = {};
    var panicActive = false;
    let wakeLock = null;

    if (isChofer) {
        document.getElementById('area-chofer').style.display = 'block';
        document.getElementById('area-monitor').style.display = 'none';
        
        // Wake Lock para evitar que la pantalla se apague
        async function activarWakeLock() {
            try { if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); } catch (e) {}
        }
        activarWakeLock();
        document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'visible') activarWakeLock(); });

        navigator.geolocation.watchPosition(pos => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            map.setView([lat, lng], 16);
            
            fetch('/update/' + trailerId, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ lat, lng, panic: panicActive, battery: "OK" })
            });
        }, null, { enableHighAccuracy: true });
    }

    function togglePanic() {
        panicActive = !panicActive;
        const btn = document.getElementById('panic-btn');
        btn.innerHTML = panicActive ? "丘멆잺 P츼NICO ACTIVO (Presiona para resolver)" : "游뚿 ACTIVAR P츼NICO";
        btn.className = panicActive ? "btn-panic btn-on" : "btn-panic btn-off";
    }

    async function updateFleet() {
        const res = await fetch('/fleet');
        const fleet = await res.json();
        const tbody = document.getElementById('table-body');
        tbody.innerHTML = "";

        for (let id in fleet) {
            const data = fleet[id];
            const pos = [data.lat, data.lng];

            if (!markers[id]) {
                markers[id] = L.marker(pos).addTo(map).bindPopup(id);
                paths[id] = L.polyline([], {color: '#3498db', weight: 4}).addTo(map);
            }
            markers[id].setLatLng(pos);
            paths[id].setLatLngs(data.path);

            tbody.innerHTML += `
                <tr>
                    <td><b>${id}</b></td>
                    <td><span class="status-pill ${data.panic ? 'st-panic' : 'st-ok'}">${data.panic ? 'ALERTA' : 'NORMAL'}</span></td>
                    <td style="color:#3498db; font-weight:bold;">${data.last_seen}</td>
                </tr>`;
            
            if(data.panic) markers[id].openPopup();
        }
    }

    setInterval(updateFleet, 4000);
</script>
</body>
</html>
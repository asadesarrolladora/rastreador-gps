<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Sistema de Flota ASA</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #121212; color: white; }
        #map { height: 55vh; width: 100%; border-bottom: 2px solid #333; }
        .container { padding: 15px; }
        
        /* Tabla Pro */
        table { width: 100%; border-collapse: collapse; background: #1e1e1e; border-radius: 8px; margin-top: 10px; }
        th { background: #2c3e50; padding: 12px; text-align: left; font-size: 12px; }
        td { padding: 12px; border-bottom: 1px solid #333; font-size: 14px; }
        
        /* Bot칩n de P치nico Dual */
        .btn-panic { width: 100%; padding: 20px; font-size: 1.2em; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-off { background: #e74c3c; color: white; box-shadow: 0 4px #c0392b; }
        .btn-on { background: #2c3e50; color: #e74c3c; border: 3px solid #e74c3c; animation: pulse 1.5s infinite; }
        
        .status-pill { padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 11px; }
        .st-ok { background: #27ae60; }
        .st-panic { background: #e74c3c; }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(231, 76, 60, 0); } 100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); } }
    </style>
</head>
<body>

<div id="map"></div>

<div class="container">
    <div id="area-chofer" style="display:none;">
        <button id="panic-btn" class="btn-panic btn-off" onclick="togglePanic()">游뚿 ACTIVAR P츼NICO</button>
        <p style="text-align:center; color: #888;">Mant칠n esta ventana abierta durante tu ruta.</p>
    </div>

    <div id="area-monitor">
        <h3>游늵 Estado de la Flota</h3>
        <table>
            <thead>
                <tr>
                    <th>Unidad</th>
                    <th>Estado</th>
                    <th>游 칔ltima Conexi칩n</th>
                </tr>
            </thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const urlParams = new URLSearchParams(window.location.search);
    const trailerId = urlParams.get('id');
    const isChofer = !!trailerId;

    var map = L.map('map').setView([19.43, -99.13], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    if (isChofer) {
        document.getElementById('area-chofer').style.display = 'block';
        document.getElementById('area-monitor').style.display = 'none';
    }

    var markers = {};
    var paths = {};
    var panicActive = false;
    let wakeLock = null;

    // --- L칍GICA WAKE LOCK (Pantalla Encendida) ---
    async function activarWakeLock() {
        try { if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {}
    }

    // --- L칍GICA CHOFER ---
    function togglePanic() {
        panicActive = !panicActive;
        const btn = document.getElementById('panic-btn');
        btn.innerHTML = panicActive ? "丘멆잺 ALERTA ACTIVA (Presiona para resolver)" : "游뚿 ACTIVAR P츼NICO";
        btn.className = panicActive ? "btn-panic btn-on" : "btn-panic btn-off";
        // Enviar actualizaci칩n inmediata
        navigator.geolocation.getCurrentPosition(p => enviarUbicacion(p));
    }

    function enviarUbicacion(pos) {
        fetch('/update/' + trailerId, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                lat: pos.coords.latitude,
                lng: pos.coords.longitude,
                panic: panicActive,
                battery: "OK"
            })
        });
    }

    if (isChofer) {
        activarWakeLock();
        navigator.geolocation.watchPosition(pos => {
            map.setView([pos.coords.latitude, pos.coords.longitude], 16);
            enviarUbicacion(pos);
        }, null, { enableHighAccuracy: true });
    }

    // --- L칍GICA MONITOR ---
    async function actualizarMonitor() {
        const res = await fetch('/fleet');
        const fleet = await res.json();
        const tbody = document.getElementById('table-body');
        tbody.innerHTML = "";

        for (let id in fleet) {
            const data = fleet[id];
            const pos = [data.lat, data.lng];

            if (!markers[id]) {
                markers[id] = L.marker(pos).addTo(map).bindPopup(id);
                paths[id] = L.polyline([], {color: '#3498db'}).addTo(map);
            }
            markers[id].setLatLng(pos);
            paths[id].setLatLngs(data.path);

            tbody.innerHTML += `
                <tr>
                    <td><b>${id}</b></td>
                    <td><span class="status-pill ${data.panic ? 'st-panic' : 'st-ok'}">${data.panic ? 'P츼NICO' : 'OK'}</span></td>
                    <td>${data.last_seen}</td>
                </tr>`;
            
            if(data.panic) markers[id].openPopup();
        }
    }

    setInterval(actualizarMonitor, 4000);
</script>
</body>
</html>
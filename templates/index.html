<!DOCTYPE html>
<html>
<head>
    <title>Monitor de Flota ASA</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: sans-serif; background: #121212; color: white; }
        #map { height: 70vh; width: 100%; }
        .panel { padding: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn-panic { background: #e74c3c; color: white; padding: 15px; border-radius: 10px; border: none; font-weight: bold; grid-column: span 2; }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="panel">
        <div id="info">Esperando se√±al...</div>
        <button class="btn-panic" onclick="enviarPanico()">üö® BOT√ìN DE P√ÅNICO</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Identificar qu√© trailer es este desde la URL (ej: ?id=Trailer01)
        const urlParams = new URLSearchParams(window.location.search);
        const trailerId = urlParams.get('id') || "Invitado";

        var map = L.map('map').setView([0, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        var marcadores = {};
        var rutas = {};

        // 1. Funci√≥n para que el CHOFER env√≠e su ubicaci√≥n
        function iniciarRastreo() {
            navigator.geolocation.watchPosition(pos => {
                fetch('/update/' + trailerId, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        lat: pos.coords.latitude,
                        lng: pos.coords.longitude,
                        battery: "Buscando..." // Opcional: a√±adir API de bater√≠a aqu√≠
                    })
                });
            }, null, { enableHighAccuracy: true });
        }

        async function enviarPanico() {
            await fetch('/update/' + trailerId, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ panic: true })
            });
            alert("¬°ALERTA DE P√ÅNICO ENVIADA!");
        }

        // 2. Funci√≥n para que la CENTRAL vea a todos
        async function refrescarMapa() {
            const res = await fetch('/fleet');
            const flota = await res.json();
            
            for (let tid in flota) {
                const data = flota[tid];
                const pos = [data.lat, data.lng];

                if (!marcadores[tid]) {
                    marcadores[tid] = L.marker(pos).addTo(map).bindPopup("Unidad: " + tid);
                    rutas[tid] = L.polyline([], {color: '#3498db'}).addTo(map);
                }
                
                marcadores[tid].setLatLng(pos);
                rutas[tid].setLatLngs(data.path);
                
                if(data.panic) {
                    marcadores[tid].bindTooltip("‚ö†Ô∏è EMERGENCIA").openTooltip();
                }
            }
        }

        setInterval(refrescarMapa, 5000);
        iniciarRastreo();
    </script>
</body>
</html>